<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>學生點數查詢</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ...你的 style 保持不變... */
  </style>
</head>
<body>
<div class="container">
  <div class="user-block">
    <img id="avatar" class="avatar" src="https://fakeimg.pl/56x56/?text=?" alt="頭像">
    <div>
      <div id="userName" class="user-name">載入中...</div>
      <div id="userId" class="user-id"></div>
    </div>
  </div>
  <div class="student-row">
    <label for="studentSel">選擇小朋友：</label>
    <select id="studentSel"></select>
    <button id="addStudentBtn" type="button">新增小朋友</button>
  </div>
  <!-- 新增小朋友 modal -->
  <div class="modal-bg" id="modalBg"></div>
  <div class="modal" id="addStudentDialog">
    <h3>新增小朋友</h3>
    <input type="text" id="newStudentName" placeholder="請輸入小朋友名字">
    <div class="modal-btns">
      <button class="ok" id="confirmAddStudent" type="button">送出</button>
      <button class="cancel" id="cancelAddStudent" type="button">取消</button>
    </div>
  </div>
  <div class="points-block">
    <div class="points-label">目前點數</div>
    <div id="pointsValue" class="points-value">--</div>
  </div>
  <div class="products-title">可兌換商品</div>
  <div class="product-list" id="productList"></div>
</div>
<div class="footer">Points Shop 學生點數查詢系統</div>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const LIFF_ID = "2008129060-mO9azRD1";
const FIREBASE_URL = "https://points-shop-47c10-default-rtdb.asia-southeast1.firebasedatabase.app";
const MAX_STUDENTS = 2;
let globalUserId = "";

function main() {
  liff.init({ liffId: LIFF_ID })
    .then(() => liff.getProfile())
    .then(profile => {
      document.getElementById('avatar').src = profile.pictureUrl || "https://fakeimg.pl/56x56/?text=?";
      document.getElementById('userName').innerText = profile.displayName || "未知用戶";
      document.getElementById('userId').innerText = profile.userId;
      globalUserId = profile.userId;
      ensureParentExists(profile.userId, profile.displayName);
      loadStudents(profile.userId);
    })
    .catch(err => {
      document.body.innerHTML = "<h2>發生錯誤，請重新開啟！</h2><pre style='color:red;font-size:0.9em;'>" + err + "</pre>";
      console.error(err);
    });
}

function ensureParentExists(userId, userName) {
  fetch(`${FIREBASE_URL}/parents/${userId}.json`)
    .then(res => res.json())
    .then(data => {
      if (data === null || !data.students) {
        fetch(`${FIREBASE_URL}/parents/${userId}.json`, {
          method: 'PATCH',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            displayName: userName,
            createdAt: new Date().toISOString(),
            students: {}
          })
        });
      }
    });
}

function loadStudents(userId) {
  fetch(`${FIREBASE_URL}/parents/${userId}/students.json`)
    .then(r => r.json())
    .then(students => {
      const sel = document.getElementById('studentSel');
      sel.innerHTML = '';
      if (!students || Object.keys(students).length === 0) {
        sel.innerHTML = '<option value="">（尚未新增小朋友）</option>';
        document.getElementById('pointsValue').innerText = "--";
        renderProducts([]);
        return;
      }
      const studentArr = Object.entries(students).map(([sid, obj]) => ({studentId: sid, name: obj.name, points: obj.points}));
      sel.innerHTML = studentArr.map(s => `<option value="${s.studentId}">${s.name}</option>`).join('');
      if (sel.value) loadStudent(sel.value);
      sel.onchange = function() { loadStudent(sel.value); };
    });
}

function loadStudent(studentId) {
  if (!studentId) {
    document.getElementById('pointsValue').innerText = "--";
    renderProducts([]);
    return;
  }
  fetch(`${FIREBASE_URL}/parents/${globalUserId}/students/${studentId}.json`)
    .then(r => r.json())
    .then(student => {
      document.getElementById('pointsValue').innerText = student && student.points !== undefined ? student.points : "--";
    });
  loadProducts();
}

function loadProducts() {
  fetch(`${FIREBASE_URL}/products.json`)
    .then(r => r.json())
    .then(products => {
      if (!products) {
        renderProducts([]);
        return;
      }
      const prodArr = Object.values(products);
      renderProducts(prodArr.map(p => [p.name, p.point, p.img]));
    });
}

function renderProducts(products) {
  const list = document.getElementById('productList');
  list.innerHTML = "";
  if (products && products.length > 0) {
    products.forEach((prod, idx) => {
      const name = prod[0] || "";
      const pts = prod[1] || 0;
      const img = prod[2] || "https://fakeimg.pl/62x62/cccccc/909090/?text=?";
      const html = `<div class="product-card" style="animation-delay:${idx*0.07}s">
        <img class="product-img" src="${img}" alt="${name}">
        <div class="product-name">${name}</div>
        <div class="product-points">${pts} 點</div>
      </div>`;
      list.insertAdjacentHTML('beforeend', html);
    });
  } else {
    list.innerHTML = '<div class="no-products">目前沒有可兌換商品</div>';
  }
}

// ===== 新增小朋友功能 + Modal動畫+數量限制2位 =====
document.addEventListener('DOMContentLoaded', function() {
  const addStudentBtn = document.getElementById('addStudentBtn');
  const addStudentDialog = document.getElementById('addStudentDialog');
  const modalBg = document.getElementById('modalBg');
  const confirmAddStudent = document.getElementById('confirmAddStudent');
  const cancelAddStudent = document.getElementById('cancelAddStudent');
  const newStudentName = document.getElementById('newStudentName');
  const studentSel = document.getElementById('studentSel');

  function showModal(flag) {
    if(flag){
      addStudentDialog.classList.add('active');
      modalBg.classList.add('active');
      addStudentDialog.style.display = '';
      modalBg.style.display = '';
      setTimeout(()=>{newStudentName.focus();}, 120);
    }else{
      addStudentDialog.classList.remove('active');
      modalBg.classList.remove('active');
      setTimeout(()=>{
        addStudentDialog.style.display = 'none';
        modalBg.style.display = 'none';
      }, 290);
    }
  }

  if (addStudentBtn) {
    addStudentBtn.onclick = function() {
      fetch(`${FIREBASE_URL}/parents/${globalUserId}/students.json`)
        .then(r => r.json())
        .then(students => {
          if (students && Object.keys(students).length >= MAX_STUDENTS) {
            alert('每位家長最多只能新增' + MAX_STUDENTS + '位小朋友！');
            return;
          }
          showModal(true);
          newStudentName.value = '';
        });
    };
  }

  if (cancelAddStudent) {
    cancelAddStudent.onclick = function() { showModal(false); };
  }
  if (modalBg) {
    modalBg.onclick = function() { showModal(false); };
  }
  if (confirmAddStudent) {
    confirmAddStudent.onclick = function() {
      const name = newStudentName.value.trim();
      if (!name) {
        alert('請輸入小朋友名字');
        return;
      }
      fetch(`${FIREBASE_URL}/parents/${globalUserId}/students.json`)
        .then(r => r.json())
        .then(students => {
          if (students) {
            if (Object.keys(students).length >= MAX_STUDENTS) {
              alert('每位家長最多只能新增' + MAX_STUDENTS + '位小朋友！');
              showModal(false);
              return;
            }
            if (Object.values(students).some(s => s.name === name)) {
              alert('已經有這個名字的小朋友囉！');
              return;
            }
          }
          const studentId = 'S' + Date.now();
          fetch(`${FIREBASE_URL}/parents/${globalUserId}/students/${studentId}.json`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ name, points: 0 })
          }).then(() => {
            showModal(false);
            loadStudents(globalUserId);
          });
        });
    };
  }
});
main();
</script>
</body>
</html>
