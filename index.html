<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>學生點數查詢</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background: radial-gradient(circle at 50% 0%, #dad4ff 0%, #f3f4f6 100%);}
    .container { max-width: 430px; margin: 40px auto 0; background: #fff; border-radius: 22px; padding: 38px 28px 32px 28px; box-shadow: 0 6px 32px rgba(120,70,255,0.13), 0 1.5px 8px rgba(0,0,0,0.07);}
    .user-block { display: flex; align-items: center; gap: 18px; margin-bottom: 28px; position: relative; z-index: 2;}
    .avatar { width: 64px; height: 64px; border-radius: 50%; box-shadow: 0 1.5px 7px #a9a4d7a0;}
    .user-name { font-weight: bold; font-size:1.08em; color: #6d5aaf;}
    .not-approved { padding: 18px 0; color: #bb1e1e; background: #ffeaea; border-radius: 10px; font-size: 1.09em; text-align:center; margin-bottom: 18px;}
    .points-block { background: linear-gradient(105deg, #f3f0ff 0%, #e0e7ff 100%); border-radius: 12px; padding: 26px 0 22px 0; text-align: center; margin-bottom: 34px; box-shadow: 0 2px 16px #b8a7ff1a;}
    .points-label { font-size:1.13em; color: #7a5cff; font-weight: 600;}
    .points-value { font-size: 2.7em; font-weight:800; color: #4b3fa0; letter-spacing: 2px; text-shadow: 0 1.5px 4px #d6d0f9;}
    .products-title { font-size:1.15em; font-weight: 700; margin: 14px 0 10px 0; color:#5445a0; letter-spacing:1px;}
    .product-list {display: flex; flex-wrap: wrap; gap: 22px; justify-content: center; margin-bottom: 10px;}
    .product-card { background: linear-gradient(120deg, #f9f7ff 0%, #ebe7ff 100%); border-radius: 20px; width: 158px; min-height: 215px; text-align: center; padding: 22px 14px 16px 14px; box-shadow: 0 6px 20px rgba(110,100,230,0.13), 0 1.5px 8px rgba(0,0,0,0.05); transition: transform 0.20s cubic-bezier(.16,.75,.36,1.13), box-shadow 0.19s; position: relative; display: flex; flex-direction: column; align-items: center; cursor: pointer; overflow: hidden; z-index:2; animation: fadeInUp 0.5s;}
    .product-card:hover { transform: translateY(-7px) scale(1.07) rotate(-2.5deg); box-shadow: 0 15px 32px rgba(76,50,180,0.19), 0 4px 24px #b8a7ff44; border: 2px solid #c2b8ff; background: linear-gradient(120deg, #f7f2fe 0%, #e2dbff 70%); filter: brightness(1.07);}
    .product-img { width: 100px; height: 100px; border-radius: 14px; object-fit: cover; box-shadow: 0 4px 16px rgba(80,60,130,0.18); margin-bottom: 10px; border: 2.5px solid #ded8ff; background: linear-gradient(135deg,#f3f0ff 0%,#e0e7ff 100%);}
    .product-name { font-size: 1.18em; font-weight: 700; color: #6546b5; margin-bottom: 7px; margin-top: 3px; letter-spacing: 0.8px; text-shadow: 0 2px 8px #e3defc88;}
    .product-points { font-size: 1.1em; color: #7a5cff; font-weight: 600; margin-bottom: 2px; display: flex; justify-content: center; align-items: center; gap: 6px; letter-spacing: 0.5px;}
    .product-points:before { content: "✨"; font-size: 1em; margin-right: 2px; opacity: 0.75;}
    @keyframes fadeInUp {from { opacity: 0; transform: translateY(40px);} to { opacity: 1; transform: translateY(0);}}
    .footer { text-align: center; color: #aaa; font-size: 0.95em; margin-top: 40px;}
  </style>
</head>
<body>
  <div class="container">
    <div class="user-block">
      <img id="avatar" class="avatar" src="https://fakeimg.pl/56x56/?text=?" alt="頭像">
      <div>
        <div id="userName" class="user-name">載入中...</div>
        <div id="userId" class="user-id" style="font-size:0.92em;color:#aaa;"></div>
      </div>
    </div>
    <div id="notApproved" class="not-approved" style="display:none;">
      尚未獲得管理員批准，請聯絡管理員。
    </div>
    <div class="points-block" id="pointsBlock" style="display:none;">
      <div class="points-label">目前點數</div>
      <div id="pointsValue" class="points-value">--</div>
    </div>
    <div class="products-title" id="productsTitle" style="display:none;">可兌換商品</div>
    <div class="product-list" id="productList" style="display:none;"></div>
  </div>
  <div class="footer">Points Shop 學生點數查詢系統</div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
const LIFF_ID = "2008129060-mO9azRD1";
const FIREBASE_URL = "https://points-shop-47c10-default-rtdb.asia-southeast1.firebasedatabase.app";
let globalUserId = "";

function main() {
  liff.init({ liffId: LIFF_ID })
    .then(() => liff.getProfile())
    .then(profile => {
      document.getElementById('avatar').src = profile.pictureUrl || "https://fakeimg.pl/56x56/?text=?";
      document.getElementById('userName').innerText = profile.displayName || "未知用戶";
      document.getElementById('userId').innerText = profile.userId;
      globalUserId = profile.userId;
      loadParent(profile.userId, profile.displayName);
    })
    .catch(err => {
      document.body.innerHTML = "<h2>發生錯誤，請重新開啟！</h2>";
      console.error(err);
    });
}

// 修正版：只在不存在時PUT，失敗會顯示錯誤
function loadParent(userId, displayName) {
  fetch(`${FIREBASE_URL}/parents/${userId}.json`)
    .then(r => r.json())
    .then(parent => {
      if (!parent) {
        // 只在資料庫不存在時嘗試註冊
        fetch(`${FIREBASE_URL}/parents/${userId}.json`, {
          method: 'PUT',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            displayName: displayName,
            approved: false,
            students: {}
          })
        })
        .then(res => {
          if(res.ok){
            showNotApproved();
          }else{
            document.getElementById('notApproved').innerText = '申請失敗，請聯絡管理員（規則設錯或權限不足）';
            document.getElementById('notApproved').style.display = '';
          }
        });
        return;
      }
      if (parent.approved !== true) {
        showNotApproved();
        return;
      }
      showApproved(parent);
    })
    .catch(err => {
      document.getElementById('notApproved').innerText = '連線失敗，請稍後再試';
      document.getElementById('notApproved').style.display = '';
    });
}

function showNotApproved() {
  document.getElementById('notApproved').style.display = '';
  document.getElementById('pointsBlock').style.display = 'none';
  document.getElementById('productsTitle').style.display = 'none';
  document.getElementById('productList').style.display = 'none';
}

function showApproved(parent) {
  document.getElementById('notApproved').style.display = 'none';
  const students = parent.students || {};
  const firstStudent = Object.values(students)[0];
  document.getElementById('pointsBlock').style.display = '';
  document.getElementById('productsTitle').style.display = '';
  document.getElementById('productList').style.display = '';
  document.getElementById('pointsValue').innerText = firstStudent && firstStudent.points !== undefined ? firstStudent.points : "--";
  loadProducts();
}

function loadProducts() {
  fetch(`${FIREBASE_URL}/products.json`)
    .then(r => r.json())
    .then(products => {
      const list = document.getElementById('productList');
      list.innerHTML = "";
      if (!products) {
        list.innerHTML = '<div style="color:#999;font-size:1em;margin:18px auto;">目前沒有可兌換商品</div>';
        return;
      }
      const prodArr = Object.values(products);
      prodArr.forEach(prod => {
        const name = prod.name || "";
        const pts = prod.point || 0;
        const img = prod.img || "https://fakeimg.pl/100x100/cccccc/909090/?text=?";
        const html = `
          <div class="product-card">
            <img class="product-img" src="${img}" alt="${name}">
            <div class="product-name">${name}</div>
            <div class="product-points">${pts} 點</div>
          </div>
        `;
        list.insertAdjacentHTML('beforeend', html);
      });
    });
}

main();
  </script>
</body>
</html>
